<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#">Student Dashboard</a>
      <div class="ms-auto text-white">
        {{ student_name }}
        <a class="btn btn-outline-light btn-sm ms-3" href="{{ url_for('logout') }}">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header">Available Questions</div>
          <div class="card-body">
            {% if questions %}
              {% for q in questions %}
                <div class="mb-4">
                  <div class="mb-1"><strong>Q{{ loop.index }}.</strong> {{ q[1] }}</div>
                  <div class="text-muted small mb-2">By: {{ q[3] }} · Max Marks: {{ q[2] }}</div>
                  {% set qid = q[0] %}
                  {% if q[5] or q[6] %}
                    <div class="small text-muted mb-2">
                      Timing (Local):
                      <span>Opens: {{ q[5] or 'Now' }}</span>
                      ·
                      <span>Closes: {{ q[6] or 'No close' }}</span>
                    </div>
                    <div class="small mb-2 js-timer" id="timer-{{ qid }}" data-open="{{ q[5] or '' }}" data-close="{{ q[6] or '' }}"></div>
                  {% endif %}
                  {% if deadline_locked_qids and (qid in deadline_locked_qids) %}
                    <div class="alert alert-warning py-2">Deadline passed. Submissions are closed.</div>
                  {% else %}
                    {% if not_open_qids and (qid in not_open_qids) %}
                      <div class="alert alert-secondary py-2 js-open-msg" data-open="{{ q[5] or '' }}" data-close="{{ q[6] or '' }}">Not open yet. Please wait until the window opens.</div>
                    {% endif %}
                    {% if submitted_qids and (qid in submitted_qids) %}
                      {% if q[4] %}
                        <div class="alert alert-info py-2">You already submitted. You may resubmit before the deadline.</div>
                        <form class="js-window-ctrl" data-open="{{ q[5] or '' }}" data-close="{{ q[6] or '' }}" method="post" action="{{ url_for('submit_answer', question_id=qid) }}">
                          <div class="mb-2">
                            <textarea class="form-control" name="answer_text" rows="3" placeholder="Update your answer..." required {% if not_open_qids and (qid in not_open_qids) %}disabled{% endif %}></textarea>
                          </div>
                          <button class="btn btn-primary btn-sm" type="submit" {% if not_open_qids and (qid in not_open_qids) %}disabled{% endif %}>Resubmit Answer</button>
                        </form>
                      {% else %}
                        <div class="alert alert-secondary py-2">Already submitted. Resubmission is locked.</div>
                      {% endif %}
                    {% else %}
                      <form class="js-window-ctrl" data-open="{{ q[5] or '' }}" data-close="{{ q[6] or '' }}" method="post" action="{{ url_for('submit_answer', question_id=qid) }}">
                        <div class="mb-2">
                          <textarea class="form-control" name="answer_text" rows="3" placeholder="Write your answer here..." required {% if not_open_qids and (qid in not_open_qids) %}disabled{% endif %}></textarea>
                        </div>
                        <button class="btn btn-primary btn-sm" type="submit" {% if not_open_qids and (qid in not_open_qids) %}disabled{% endif %}>Submit Answer</button>
                      </form>
                    {% endif %}
                  {% endif %}
                </div>
                <hr/>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">No questions available yet.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header">My Submissions</div>
          <div class="card-body table-responsive">
            {% if my_submissions %}
              <table class="table table-striped align-middle">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Question</th>
                    <th>Obtained-Score</th>
                    <th>Submitted</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in my_submissions %}
                    <tr>
                      <td>{{ s[0] }}</td>
                      <td class="text-truncate" style="max-width: 260px;">{{ s[2] }}</td>
                      <td>{{ '%.2f'|format(s[3]) }}</td>
                      <td><small>{{ s[5] }}</small></td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <p class="text-muted mb-0">No submissions yet.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      var serverNowStr = '{{ server_now }}';
      var serverNow = serverNowStr ? new Date(serverNowStr) : new Date();
      var clientNow = new Date();
      var offsetMs = serverNow.getTime() - clientNow.getTime();
      function parseISO(s){ if(!s) return null; var d = new Date(s); return isNaN(d.getTime()) ? null : d; }
      function pad(n){ return n<10?'0'+n:n; }
      function fmt(ms){ if(ms<0) ms=0; var sec=Math.floor(ms/1000)%60; var min=Math.floor(ms/60000)%60; var hr=Math.floor(ms/3600000); return pad(hr)+':'+pad(min)+':'+pad(sec); }
      function isWindowOpen(open, close, now){
        return (!open || now >= open) && (!close || now < close);
      }
      function tick(){
        var now = new Date(Date.now() + offsetMs);
        document.querySelectorAll('.js-timer').forEach(function(el){
          var open = parseISO(el.dataset.open);
          var close = parseISO(el.dataset.close);
          var text = '';
          if (open && now < open) text = 'Opens in ' + fmt(open - now);
          else if (close) text = now < close ? 'Time left ' + fmt(close - now) : 'Closed';
          el.textContent = text;
        });
        document.querySelectorAll('.js-window-ctrl').forEach(function(el){
          var open = parseISO(el.dataset.open);
          var close = parseISO(el.dataset.close);
          var enable = isWindowOpen(open, close, now);
          el.querySelectorAll('textarea,button,input,select').forEach(function(ctrl){ ctrl.disabled = !enable; });
        });
        document.querySelectorAll('.js-open-msg').forEach(function(el){
          var open = parseISO(el.dataset.open);
          var close = parseISO(el.dataset.close);
          var enable = isWindowOpen(open, close, now);
          el.style.display = enable ? 'none' : '';
        });
      }
      tick();
      setInterval(tick, 1000);

      (function scheduleAutoReload(){
        var now = new Date(Date.now() + offsetMs);
        var soonestMs = null;
        document.querySelectorAll('.js-timer').forEach(function(el){
          var open = parseISO(el.dataset.open);
          var close = parseISO(el.dataset.close);
          if (open && now < open) {
            var ms = open - now;
            if (soonestMs === null || ms < soonestMs) soonestMs = ms;
          }
          if (close && now < close) {
            var ms2 = close - now;
            if (soonestMs === null || ms2 < soonestMs) soonestMs = ms2;
          }
        });
        if (soonestMs !== null && soonestMs > 0 && soonestMs < 24*60*60*1000) {
          var delay = Math.min(soonestMs + 1000, 2147483647);
          setTimeout(function(){ location.reload(); }, delay);
        }
      })();
    })();
  </script>
</body>
</html>
